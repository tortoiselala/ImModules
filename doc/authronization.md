# 关于本系统的权限认证系统设计

为了满足扩展的要求，将权限认证服务作为独立服务运行，作为一个只做权限认证以及证书颁布的认证中心

以下列举常见的权限认证方式：
在单应用中，传统的认证方式是在请求到达服务端后，拦截器拦截并进行权限校验，在登录时将用户信息缓存到session中，在之后则直接从缓存中访问用户信息。


微服务架构下，服务被拆分。

David Borsos 在伦敦的微服务大会上提出了四种方案。
1. 单点登录（SSO）
单点登录（英语：Single sign-on，缩写为 SSO），又译为单一签入，
一种对于许多相互关连，但是又是各自独立的软件系统，提供访问控制的属性。
当拥有这项属性时，当用户登录时，就可以获取所有系统的访问权限，不用对每个单一系统都逐一登录。
这项功能通常是以轻型目录访问协议（LDAP）来实现，在服务器上会将用户信息存储到LDAP数据库中。
相同的，单一退出（single sign-off）就是指，只需要单一的退出动作，就可以结束对于多个系统的访问权限。

https://cloud.tencent.com/developer/article/1166255

2. 分布式Session方案

分布式会话方案原理主要是将关于用户认证的信息存储在共享存储中，
且通常由用户会话作为 key 来实现的简单分布式哈希映射。
当用户访问微服务时，用户数据可以从共享存储中获取。
在某些场景下，这种方案很不错，用户登录状态是不透明的。同时也是一个高可用且可扩展的解决方案。
这种方案的缺点在于共享存储需要一定保护机制，因此需要通过安全链接来访问，
这时解决方案的实现就通常具有相当高的复杂性了。

3. 客户端 Token 方案

令牌在客户端生成，由身份验证服务进行签名，并且必须包含足够的信息，
以便可以在所有微服务中建立用户身份。
令牌会附加到每个请求上，为微服务提供用户身份验证，
这种解决方案的安全性相对较好，但身份验证注销是一个大问题，
缓解这种情况的方法可以使用短期令牌和频繁检查认证服务等。
对于客户端令牌的编码方案，Borsos 更喜欢使用 JSON Web Tokens（JWT），
它足够简单且库支持程度也比较好。

4. 客户端 Token 与 API 网关结合

这个方案意味着所有请求都通过网关，从而有效地隐藏了微服务。 
在请求时，网关将原始用户令牌转换为内部会话 ID 令牌。
在这种情况下，注销就不是问题，因为网关可以在注销时撤销用户的令牌。


本系统采用基于Token的方案，使用JWT作为Token发布方案

流程如下：
服务端启动时设置RSA算法的私钥ServerPrivateKey与公钥SeverPublicKey
客户端请求getPublicKey接口获取公钥ServerPublicKey
客户端生成私钥ClientPrivateKey和公钥ClientPublicKey
客户端将username和password和ClientPublicKey发送给服务端
服务端使用ServerPrivateKey解密得到username,password和ClientPublicKey
服务端权限认证成功后生成JWT，将JWT使用ClientPublicKey加密发送到客户端
客户端使用ClientPrivateKey加密


server生成token后存储在redis中
为了不同客户端（PC，手机）能够得知各自的状态

不同域间需要登录时，首先重定向至登录接口，服务器判断，如果已经登录，则直接返回token

